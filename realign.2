#!/bin/bash -e
##realign <name-paired-end.bam>
##sort qname bam > create fastq > bwa mem > sort position > <name.ra.bam>

ref="/NGS/sanger/REFS/SARS-CoV_ISv0.3.2.1.fasta"
bed1="/NGS/sanger/REFS/nCoV-2019-snaq.bed"

pi=$(dirname "${1}")
fp=$(basename "$1")
fe=${fp##*.}
fn=${fp%.*}
if [[ $fe -ne "bam" ]];then
        echo "Input file not bam"
        exit 1
fi
VCFile="${pi}/${fn}.vcf"
InputFile="${pi}/${fn}.${fe}"

echo "sorting by qname.."
samtools sort -n $InputFile -o "${pi}/${fn}-rsort.bam" -O bam -@ 32 -m 1G
echo "creating fastq..."
samtools fastq -1 "${pi}/${fn}-R1.fastq" -2 "${pi}/${fn}-R2.fastq" -0 "${pi}/${fn}-bad.fastq" -s "${pi}/${fn}-singles.fastq" "${pi}/${fn}-rsort.bam"
echo "aligning..."
bwa mem -t 32 $ref "${pi}/${fn}-R1.fastq" "${pi}/${fn}-R2.fastq" > "${pi}/${fn}.sam"
echo "Positional Sorting..."
samtools sort "${pi}/${fn}.sam" -l 1 -@ 32 -m 1G -o "${pi}/${fn}.ra.bam"
samtools index "${pi}/${fn}.ra.bam"

echo "cleaning up..."
rm -f "${pi}/${fn}-rsort.bam" "${pi}/${fn}-bad.fastq" "${pi}/${fn}-singles.fastq" "${pi}/${fn}-R1.fastq" "${pi}/${fn}-R2.fastq" "${pi}/${fn}.sam"
